#!/usr/bin/env bash
#
# Pre-push hook: enforce 90% code coverage on every source file.
# Symlink into .git/hooks/pre-push to activate.
#
set -euo pipefail

MINIMUM_COVERAGE=90
PROJECT_DIR="$(git rev-parse --show-toplevel)/Zaap"
SCHEME="Zaap"
RESULT_BUNDLE="/tmp/zaap-coverage-$$.xcresult"

# Simulator device: check env var, then .zaap-simulator file, then auto-detect
if [ -n "${ZAAP_SIMULATOR:-}" ]; then
  SIMULATOR_NAME="$ZAAP_SIMULATOR"
elif [ -f "$(git rev-parse --show-toplevel)/.zaap-simulator" ]; then
  SIMULATOR_NAME="$(cat "$(git rev-parse --show-toplevel)/.zaap-simulator" | tr -d '[:space:]')"
else
  # Auto-detect first available iPhone simulator
  SIMULATOR_NAME=$(xcrun simctl list devices available -j 2>/dev/null \
    | python3 -c "
import json, sys
data = json.load(sys.stdin)
for runtime, devices in data.get('devices', {}).items():
    for d in devices:
        if 'iPhone' in d['name'] and d['isAvailable']:
            print(d['name']); sys.exit(0)
" 2>/dev/null)
  if [ -z "$SIMULATOR_NAME" ]; then
    echo "‚ùå No available iPhone simulator found. Set ZAAP_SIMULATOR or create .zaap-simulator file."
    exit 1
  fi
  echo "‚ÑπÔ∏è  Auto-detected simulator: $SIMULATOR_NAME"
fi

cleanup() { rm -rf "$RESULT_BUNDLE"; }
trap cleanup EXIT

echo "üîç Running tests with coverage‚Ä¶"
xcodebuild test \
  -project "$PROJECT_DIR/Zaap.xcodeproj" \
  -scheme "$SCHEME" \
  -destination "platform=iOS Simulator,name=$SIMULATOR_NAME" \
  -enableCodeCoverage YES \
  -resultBundlePath "$RESULT_BUNDLE" \
  -quiet 2>&1

if [ ! -d "$RESULT_BUNDLE" ]; then
  echo "‚ùå Tests failed or result bundle not found. Push aborted."
  exit 1
fi

echo "üìä Checking coverage‚Ä¶"

FAILED=0

# SwiftUI view files are excluded ‚Äî they require snapshot/UI testing
EXCLUDED_FILES="ContentView.swift|DashboardView.swift|SettingsView.swift|RequestLogView.swift|ZaapApp.swift"

# Parse per-file coverage from xcrun xccov
while IFS= read -r line; do
  # xccov report lines look like:  "SomeFile.swift    85.71% (6/7)"
  file=$(echo "$line" | sed 's/[[:space:]]*[0-9].*$//')
  pct=$(echo "$line" | grep -oE '[0-9]+\.[0-9]+%' | head -1 | tr -d '%')

  [ -z "$pct" ] && continue

  # Skip excluded view files
  basename=$(basename "$file")
  if echo "$basename" | grep -qE "^($EXCLUDED_FILES)$"; then
    continue
  fi

  # Compare as integers (floor)
  int_pct=$(echo "$pct" | cut -d. -f1)

  if [ "$int_pct" -lt "$MINIMUM_COVERAGE" ]; then
    echo "  ‚ö†Ô∏è  ${file}: ${pct}% (minimum ${MINIMUM_COVERAGE}%)"
    FAILED=1
  fi
done < <(xcrun xccov view --report --files-for-target Zaap "$RESULT_BUNDLE" 2>/dev/null \
         || xcrun xccov view --report "$RESULT_BUNDLE" | grep '\.swift')

if [ "$FAILED" -eq 1 ]; then
  echo ""
  echo "‚ùå Coverage below ${MINIMUM_COVERAGE}% on one or more files. Push aborted."
  exit 1
fi

echo "‚úÖ All source files meet ${MINIMUM_COVERAGE}% coverage. Pushing‚Ä¶"
exit 0
